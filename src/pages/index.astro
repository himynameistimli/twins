---
import Layout from '../layouts/Layout.astro';
import NotificationBanner from '../components/NotificationBanner.astro';
import ChildPanel from '../components/ChildPanel.astro';
import Modals from '../components/Modals.astro';
---

<Layout title="Twins Tracker">
  <NotificationBanner />
  
  <!-- Mobile Integrated Header (phones only) - tabs built into header -->
  <div class="mobile-header sm:hidden">
    <button class="mobile-name-tab active" data-tab="0" id="mobile-tab-0">
      <span class="name-text" data-tab-name="0">Emily</span>
      <span class="urgent-dot"></span>
    </button>
    <span class="header-divider">|</span>
    <button class="mobile-name-tab" data-tab="1" id="mobile-tab-1">
      <span class="name-text" data-tab-name="1">Jimmy</span>
      <span class="urgent-dot"></span>
    </button>
    <div class="header-date">
      <span class="date-display text-xs text-gray-400"></span>
    </div>
  </div>
  
  <div class="panels-container flex h-screen w-screen transition-[padding-top] duration-300 sm:flex-row">
    <ChildPanel side="left" childIndex={0} defaultName="Emily" />
    <ChildPanel side="right" childIndex={1} defaultName="Jimmy" />
  </div>
  
  <Modals />
</Layout>

<style is:global>
  /* Mobile Integrated Header - compact name tabs */
  .mobile-header {
    @apply fixed top-0 left-0 right-0 z-50 flex items-center justify-center gap-2 bg-dark/95 backdrop-blur-sm;
    height: 40px;
    padding-top: env(safe-area-inset-top, 0px);
  }
  
  /* Ensure header is hidden on tablet and larger */
  @media (min-width: 640px) {
    .mobile-header {
      display: none !important;
    }
  }
  
  .mobile-name-tab {
    @apply relative bg-transparent border-none cursor-pointer transition-all px-1;
  }
  
  .mobile-name-tab .name-text {
    @apply text-lg font-bold opacity-40 transition-all;
  }
  
  .mobile-name-tab.active .name-text {
    @apply opacity-100;
  }
  
  .mobile-name-tab[data-tab="0"] .name-text {
    @apply text-accent-left;
  }
  
  .mobile-name-tab[data-tab="1"] .name-text {
    @apply text-accent-right;
  }
  
  .header-divider {
    @apply text-gray-600 text-xs font-light;
  }
  
  .header-date {
    @apply absolute right-2;
  }
  
  /* Urgent notification dot on name tab */
  .mobile-name-tab .urgent-dot {
    @apply absolute -top-0.5 -right-0.5 w-1.5 h-1.5 bg-urgent rounded-full opacity-0 transition-opacity;
    animation: pulse-urgent 1.5s infinite;
  }
  
  .mobile-name-tab.has-urgent .urgent-dot {
    @apply opacity-100;
  }
  
  /* Hide individual child headers on mobile (using integrated header) */
  @media (max-width: 639px) {
    .child-panel .child-header {
      display: none !important;
    }
  }
  
  /* Mobile phone panels behavior (tabs + single panel view) */
  @media (max-width: 639px) {
    .panels-container {
      padding-top: calc(40px + env(safe-area-inset-top, 0px));
      flex-direction: row;
      overflow: hidden;
    }
    
    .child-panel {
      @apply w-full flex-shrink-0;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .child-panel[data-child="0"] {
      transform: translateX(0);
    }
    
    .child-panel[data-child="1"] {
      transform: translateX(0);
    }
    
    /* When viewing second child */
    .panels-container.show-child-1 .child-panel[data-child="0"] {
      transform: translateX(-100%);
    }
    
    .panels-container.show-child-1 .child-panel[data-child="1"] {
      transform: translateX(-100%);
    }
    
    /* Hide the border on mobile since panels are full width */
    .child-panel.border-r-2 {
      @apply border-r-0;
    }
  }
  
  /* Tablet and larger: side-by-side layout */
  @media (min-width: 640px) {
    .panels-container {
      padding-top: 0;
    }
    
    .child-panel {
      @apply w-1/2;
    }
  }
  
  /* Container notification state */
  .container.has-notification {
    padding-top: 60px;
  }

  /* Med buttons (dynamically rendered) - fixed size */
  .med-btn {
    @apply flex flex-col items-center justify-center p-2 border-none rounded-lg cursor-pointer transition-all overflow-hidden;
    min-height: 68px;
  }

  .med-btn:active {
    @apply scale-95;
  }

  .med-btn.urgent {
    background: linear-gradient(135deg, #b91c1c, #991b1b);
    @apply animate-pulse-urgent;
  }

  .med-btn.soon {
    @apply bg-card border border-border;
  }

  .med-btn.normal {
    @apply bg-card border border-border;
  }

  .med-btn.done {
    @apply bg-card border border-border opacity-50;
  }

  .med-btn.add-new {
    @apply bg-transparent border-2 border-dashed border-border;
  }

  .med-btn.add-new:hover,
  .med-btn.add-new:active {
    @apply border-normal;
  }

  .med-btn.add-new .med-name {
    @apply text-gray-400;
  }

  .med-btn.add-new .med-status {
    @apply text-gray-400 text-[10px];
  }

  .med-name {
    @apply font-bold text-white text-center leading-tight text-sm w-full px-0.5;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .med-status {
    @apply text-xs text-white/85 mt-0.5 w-full text-center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .med-time {
    @apply text-[11px] text-white/70;
  }

  /* Edit mode - iOS-style jiggle animation */
  @keyframes jiggle {
    0%, 100% { transform: rotate(-0.5deg); }
    50% { transform: rotate(0.5deg); }
  }

  .meds-grid.edit-mode {
    overflow: visible !important;
  }

  .meds-grid.edit-mode .med-btn {
    animation: jiggle 0.25s ease-in-out infinite;
    position: relative;
    overflow: visible;
  }

  .meds-grid.edit-mode .med-btn:nth-child(even) {
    animation-delay: 0.125s;
  }

  .meds-grid.edit-mode .med-btn:nth-child(3n) {
    animation-duration: 0.3s;
  }

  .meds-grid.edit-mode .med-btn.add-new {
    animation: none;
    display: none;
  }

  /* X delete button - partially outside top-right corner */
  .med-delete-btn {
    @apply absolute w-5 h-5 bg-urgent rounded-full flex items-center justify-center text-white text-[10px] font-bold z-30 opacity-0 pointer-events-none transition-all border-none cursor-pointer;
    top: -6px;
    right: -6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    -webkit-tap-highlight-color: transparent;
  }

  .meds-grid.edit-mode .med-delete-btn {
    @apply opacity-100 pointer-events-auto;
  }

  .med-delete-btn:hover {
    @apply bg-red-500;
  }

  .med-delete-btn:active {
    transform: scale(0.85);
  }

  /* Event edit mode - jiggle animation for planner events */
  @keyframes jiggle-event {
    0%, 100% { transform: rotate(-0.3deg); }
    50% { transform: rotate(0.3deg); }
  }

  .jiggle-event {
    animation: jiggle-event 0.25s ease-in-out infinite;
    transform-origin: center center;
    overflow: visible !important;
  }

  .jiggle-event:nth-child(even) {
    animation-delay: 0.12s;
  }

  .jiggle-event:nth-child(3n) {
    animation-duration: 0.3s;
  }

  /* Event delete button */
  .event-delete-btn {
    @apply w-4 h-4 bg-urgent rounded-full flex items-center justify-center text-white text-[9px] font-bold z-30 flex-shrink-0 ml-auto cursor-pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    -webkit-tap-highlight-color: transparent;
  }

  .event-delete-btn:hover {
    @apply bg-red-500;
  }

  .event-delete-btn:active {
    transform: scale(0.85);
  }

  /* Planner container overflow in edit mode */
  .event-edit-mode {
    overflow: visible !important;
  }

  /* Event edit mode Done button */
  .event-edit-done-btn {
    @apply absolute top-2 right-2 px-3 py-1 bg-green-600 text-white text-xs font-semibold rounded-lg z-40 opacity-0 pointer-events-none transition-all;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  .planner-container:has(.event-edit-mode) .event-edit-done-btn {
    @apply opacity-100 pointer-events-auto;
  }

  .event-edit-done-btn:active {
    transform: scale(0.95);
  }

  /* Done editing button */
  .edit-done-btn {
    @apply bg-normal text-white px-3 py-1 rounded text-xs font-semibold cursor-pointer transition-all;
  }

  .edit-done-btn:hover {
    @apply bg-normal/80;
  }

  /* Item list in modals (dynamically rendered) */
  .item-list-item {
    @apply flex justify-between items-center p-3 bg-card rounded-lg mb-2;
  }

  .item-list-item .info {
    @apply flex-1;
  }

  .item-list-item .name {
    @apply font-semibold mb-0.5;
  }

  .item-list-item .details {
    @apply text-xs text-gray-400;
  }

  .item-list-item button {
    @apply bg-urgent text-white border-none px-3 py-1.5 rounded-md cursor-pointer text-xs;
  }

  /* Feed wheel touch feedback */
  .feed-wheel button:active {
    @apply scale-95;
  }

  .feed-wheel-main:active {
    @apply bg-normal/30;
  }

  /* Date navigation */
  .date-nav {
    @apply select-none;
  }

  .date-nav-btn {
    @apply rounded-md active:scale-90 transition-all;
  }

  .date-nav-btn:disabled {
    @apply pointer-events-none;
  }

  /* Past date viewing indicator */
  .container.viewing-past {
    @apply relative;
  }

  .container.viewing-past::before {
    content: '';
    @apply absolute inset-0 pointer-events-none z-50;
    background: linear-gradient(180deg, rgba(245, 158, 11, 0.05) 0%, transparent 100px);
  }

  /* Draggable events */
  .planner-event[data-draggable="true"] {
    @apply select-none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
    touch-action: none;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .planner-event[data-draggable="true"] * {
    @apply select-none;
    -webkit-user-select: none;
    pointer-events: none;
  }

  .planner-event[data-draggable="true"]:active {
    @apply cursor-grabbing;
  }

  .planner-event.dragging {
    @apply cursor-grabbing z-50;
    transform: scale(1.02);
    box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
    animation: pulse-drag 1s infinite;
  }

  @keyframes pulse-drag {
    0%, 100% { 
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); 
    }
    50% { 
      box-shadow: 0 0 25px rgba(99, 102, 241, 0.7); 
    }
  }

  /* Disable pointer events on other elements while dragging */
  body.dragging-event .planner-event:not(.dragging) {
    @apply pointer-events-none opacity-50;
  }

  body.dragging-event .planner-viewport {
    overflow: hidden !important;
  }

  /* Prevent any text selection while dragging */
  body.dragging-event {
    @apply select-none;
    -webkit-user-select: none;
    cursor: grabbing !important;
  }

  body.dragging-event * {
    cursor: grabbing !important;
  }
</style>

<script>
  import { init } from '../scripts/tracker';
  
  document.addEventListener('DOMContentLoaded', init);
  
  // Mobile tab switching
  let currentMobileChild = 0;
  
  function switchToChild(childIndex: number) {
    const tabs = document.querySelectorAll('.mobile-name-tab');
    const panelsContainer = document.querySelector('.panels-container');
    
    if (childIndex < 0 || childIndex > 1) return;
    if (childIndex === currentMobileChild) return;
    
    currentMobileChild = childIndex;
    
    // Update active tab
    tabs.forEach(t => t.classList.remove('active'));
    tabs[childIndex]?.classList.add('active');
    
    // Switch panel
    if (childIndex === 1) {
      panelsContainer?.classList.add('show-child-1');
    } else {
      panelsContainer?.classList.remove('show-child-1');
    }
    
    // Haptic feedback
    if ('vibrate' in navigator) {
      navigator.vibrate(10);
    }
  }
  
  function setupMobileTabs() {
    const tabs = document.querySelectorAll('.mobile-name-tab');
    const panelsContainer = document.querySelector('.panels-container');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const childIndex = parseInt(tab.getAttribute('data-tab') || '0');
        switchToChild(childIndex);
      });
    });
    
    // Update tab names when child names change
    const nameObserver = new MutationObserver(() => {
      document.querySelectorAll('[data-child-name]').forEach((el, i) => {
        const tabName = document.querySelector(`[data-tab-name="${i}"]`);
        if (tabName && el.textContent) {
          tabName.textContent = el.textContent;
        }
      });
    });
    
    document.querySelectorAll('[data-child-name]').forEach(el => {
      nameObserver.observe(el, { childList: true, characterData: true, subtree: true });
    });
    
    // Sync urgent status from panels to mobile tabs
    const urgentObserver = new MutationObserver(() => {
      document.querySelectorAll('.child-panel').forEach((panel) => {
        const childIndex = panel.getAttribute('data-child');
        const tab = document.getElementById(`mobile-tab-${childIndex}`);
        if (tab) {
          if (panel.classList.contains('has-urgent')) {
            tab.classList.add('has-urgent');
          } else {
            tab.classList.remove('has-urgent');
          }
        }
      });
    });
    
    document.querySelectorAll('.child-panel').forEach(panel => {
      urgentObserver.observe(panel, { attributes: true, attributeFilter: ['class'] });
    });
    
    // Swipe gesture support for mobile tab switching
    setupMobileSwipe(panelsContainer);
  }
  
  function setupMobileSwipe(container: Element | null) {
    if (!container) return;
    
    // Only enable on mobile phones (< 640px, matching Tailwind's sm breakpoint)
    const isMobile = () => window.innerWidth < 640;
    
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let isSwiping = false;
    
    const SWIPE_THRESHOLD = 60;
    const VERTICAL_THRESHOLD = 50;
    
    container.addEventListener('touchstart', (e: Event) => {
      if (!isMobile()) return;
      
      const touch = (e as TouchEvent).touches[0];
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
      touchEndX = touchStartX;
      isSwiping = true;
    }, { passive: true });
    
    container.addEventListener('touchmove', (e: Event) => {
      if (!isSwiping || !isMobile()) return;
      
      const touch = (e as TouchEvent).touches[0];
      touchEndX = touch.clientX;
      
      // Cancel if scrolling vertically
      const deltaY = Math.abs(touch.clientY - touchStartY);
      if (deltaY > VERTICAL_THRESHOLD) {
        isSwiping = false;
      }
    }, { passive: true });
    
    container.addEventListener('touchend', () => {
      if (!isSwiping || !isMobile()) return;
      isSwiping = false;
      
      const deltaX = touchEndX - touchStartX;
      
      if (Math.abs(deltaX) > SWIPE_THRESHOLD) {
        if (deltaX < 0 && currentMobileChild === 0) {
          // Swipe left: show child 1
          switchToChild(1);
        } else if (deltaX > 0 && currentMobileChild === 1) {
          // Swipe right: show child 0
          switchToChild(0);
        }
      }
      
      touchStartX = 0;
      touchEndX = 0;
    }, { passive: true });
  }
  
  document.addEventListener('DOMContentLoaded', setupMobileTabs);
</script>
