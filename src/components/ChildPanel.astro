---
interface Props {
  side: 'left' | 'right';
  childIndex: number;
  defaultName: string;
}

const { side, childIndex, defaultName } = Astro.props;
const isLeft = side === 'left';
---

<div 
  class:list={[
    'child-panel h-full flex flex-col p-4 overflow-hidden relative',
    { 'border-r-2 border-border': isLeft }
  ]}
  data-child={childIndex}
>
  <!-- Floating urgent tooltip -->
  <div class="urgent-tooltip" id={`urgent-tooltip-${childIndex}`}>
    <span class="tooltip-icon">‚è∞</span>
    <span class="tooltip-text" id={`tooltip-text-${childIndex}`}></span>
    <div class="tooltip-buttons">
      <button class="tooltip-btn ignore-btn" data-action="dismiss-tooltip" data-child={childIndex}>Ignore</button>
      <button class="tooltip-btn add-btn" data-action="add-overdue-med" data-child={childIndex}>Add</button>
    </div>
  </div>

  <!-- Header (hidden on mobile, shown on tablet+) -->
  <div class="child-header flex items-center mb-2 relative">
    <!-- Left side: name for left panel, sync status placeholder for right -->
    <div class="flex items-center gap-2 flex-1">
      {isLeft && (
        <h1 
          class="text-2xl font-bold cursor-pointer text-accent-left"
          data-child-name={childIndex}
        >
          {defaultName}
        </h1>
      )}
      {isLeft && (
        <div class="sync-status" id="sync-status" title="Sync status">
          <span class="sync-icon">‚óè</span>
        </div>
      )}
    </div>
    
    <!-- Center: tabs -->
    <div class="header-tabs flex absolute left-1/2 -translate-x-1/2">
      <button 
        class="header-tab active"
        data-tab="summary"
        data-child={childIndex}
      >
        Next
      </button>
      <button 
        class="header-tab"
        data-tab="events"
        data-child={childIndex}
      >
        Events
      </button>
    </div>
    
    <!-- Right side: name for right panel -->
    <div class="flex items-center justify-end flex-1">
      {!isLeft && (
        <h1 
          class="text-2xl font-bold cursor-pointer text-accent-right"
          data-child-name={childIndex}
        >
          {defaultName}
        </h1>
      )}
    </div>
  </div>
  
  <!-- Daily Planner (Top Section - flexible, shrinks to give controls space) -->
  <div class="planner-container flex-1 bg-panel rounded-xl mb-2 overflow-hidden min-h-0 relative flex flex-col">
    <!-- Tab Content -->
    <div class="planner-tab-content flex-1 min-h-0 relative">
      <!-- Summary Tab (visible by default) -->
      <div 
        class="tab-panel active"
        id={`summary-tab-${childIndex}`}
        data-panel="summary"
      >
        <div class="summary-content h-full flex flex-col items-center justify-start gap-4 p-4 pt-2" id={`summary-content-${childIndex}`}>
          <!-- Next feed and next medication will be rendered here -->
        </div>
      </div>
      
      <!-- Events Tab -->
      <div 
        class="tab-panel"
        id={`events-tab-${childIndex}`}
        data-panel="events"
      >
        <div 
          class="planner-viewport h-full overflow-auto"
          id={`planner-${childIndex}`}
          data-child={childIndex}
        >
          <div class="planner-content" id={`planner-content-${childIndex}`}>
            <!-- Timeline will be rendered here -->
          </div>
        </div>
        <!-- Done button for event edit mode -->
        <button 
          class="event-edit-done-btn"
          id={`event-edit-done-${childIndex}`}
          onclick={`exitEventEditMode(${childIndex})`}
        >
          Done
        </button>
      </div>
    </div>
  </div>
  
  <!-- Bottom Controls Section - fixed height for 2 rows of meds -->
  <div class="controls-section flex flex-col gap-2 flex-shrink-0">
    <!-- Meds Row - Fixed height for 2 rows -->
    <div class="bg-panel rounded-xl p-3 flex flex-col meds-wrapper" style="height: 200px;">
      <div class="flex justify-between items-center mb-2 flex-shrink-0">
        <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Medications</span>
      </div>
      <div id={`meds-grid-${childIndex}`} class="meds-grid gap-2 flex-1"></div>
    </div>
    
    <!-- Feed & Diapers Row -->
    <div class="bg-panel rounded-xl p-3 flex-shrink-0">
      <div class="flex gap-2 h-20">
        <!-- Feed control with +/- buttons -->
        <div 
          class="feed-control flex-1 flex items-center bg-card border border-border rounded-xl overflow-hidden select-none"
          id={`feed-control-${childIndex}`}
        >
          <!-- Decrease button -->
          <button 
            class="feed-adjust-btn h-full w-12 flex items-center justify-center text-2xl font-bold text-red-400 hover:bg-red-500/20 active:bg-red-500/30 transition-all border-r border-border/50"
            data-action="adjust-feed"
            data-child={childIndex}
            data-delta="-10"
          >
            ‚àí
          </button>
          <!-- Feed display (tappable to log) -->
          <div 
            class="feed-display flex-1 h-full flex flex-col items-center justify-center cursor-pointer hover:bg-white/5 active:bg-white/10 transition-all py-1"
            data-action="log-feed"
            data-child={childIndex}
          >
            <div class="flex items-center gap-1">
              <span class="text-base">üçº</span>
              <span class="text-xl font-bold leading-none" id={`feed-amount-${childIndex}`}>120</span>
              <span class="text-xs text-gray-400">mL</span>
            </div>
            <div class="w-full px-2 mt-1">
              <div class="feed-progress-bar w-full h-1 bg-gray-700 rounded-full overflow-hidden">
                <div class="feed-progress-fill h-full bg-blue-500 rounded-full transition-all" id={`feed-progress-${childIndex}`} style="width: 0%"></div>
              </div>
              <div class="text-[10px] text-gray-400 text-center mt-0.5" id={`feed-daily-${childIndex}`}>0/0 mL</div>
            </div>
          </div>
          <!-- Increase button -->
          <button 
            class="feed-adjust-btn h-full w-12 flex items-center justify-center text-2xl font-bold text-green-400 hover:bg-green-500/20 active:bg-green-500/30 transition-all border-l border-border/50"
            data-action="adjust-feed"
            data-child={childIndex}
            data-delta="10"
          >
            +
          </button>
        </div>
        
        <!-- Diaper buttons with labels -->
        <button 
          class="w-20 h-full border border-border rounded-xl font-semibold cursor-pointer flex flex-col items-center justify-center gap-0.5 bg-card text-white active:scale-95 transition-all"
          data-action="log-diaper" 
          data-child={childIndex} 
          data-type="pee"
        >
          <span class="text-lg">üíß</span>
          <span class="text-xs text-gray-400">Pee</span>
          <span class="text-sm font-bold" id={`pee-count-${childIndex}`}>0</span>
        </button>
        <button 
          class="w-20 h-full border border-border rounded-xl font-semibold cursor-pointer flex flex-col items-center justify-center gap-0.5 bg-card text-white active:scale-95 transition-all"
          data-action="log-diaper" 
          data-child={childIndex} 
          data-type="poop"
        >
          <span class="text-lg">üí©</span>
          <span class="text-xs text-gray-400">Poop</span>
          <span class="text-sm font-bold" id={`poop-count-${childIndex}`}>0</span>
        </button>
      </div>
    </div>
  </div>
</div>

<style is:global>
  
  /* Header Tabs (inline with name) */
  .header-tabs {
    @apply flex bg-card/50 rounded-lg overflow-hidden;
  }
  
  .header-tab {
    @apply px-3 py-1 text-xs font-semibold text-gray-400 bg-transparent border-none cursor-pointer transition-all;
  }
  
  .header-tab:hover {
    @apply text-gray-300;
  }
  
  .header-tab.active {
    @apply text-white bg-accent-left/30;
  }
  
  /* Right panel uses different accent */
  .child-panel:not(.border-r-2) .header-tab.active {
    @apply bg-accent-right/30;
  }
  
  /* Tab panel styling */
  .planner-tab-content {
    position: relative;
  }
  
  .tab-panel {
    position: absolute;
    inset: 0;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }
  
  .tab-panel.active {
    opacity: 1;
    visibility: visible;
    position: relative;
    height: 100%;
  }
  
  /* Summary tab content - vertical stacked layout */
  .summary-content {
    @apply flex-col justify-center items-stretch gap-6 px-4;
  }
  
  /* Each row: time left, value right */
  .summary-row {
    @apply flex items-center justify-between w-full;
  }
  
  .summary-row-left {
    @apply flex flex-col items-start gap-0;
  }
  
  .summary-row-right {
    @apply flex flex-col items-end gap-0;
  }
  
  .summary-label {
    @apply text-[10px] uppercase tracking-widest text-gray-500 font-medium;
    letter-spacing: 0.1em;
  }
  
  .summary-time {
    @apply text-4xl font-bold leading-tight;
  }
  
  .summary-time.urgent {
    @apply text-urgent;
  }
  
  .summary-time.soon {
    @apply text-yellow-400;
  }
  
  .summary-time.normal {
    @apply text-white;
  }
  
  .summary-time.done {
    @apply text-gray-500;
  }
  
  .summary-time.warning {
    @apply text-amber-400;
  }
  
  .summary-row.weight .summary-row-right {
    @apply flex-row items-center;
  }
  
  /* Consolidated stats section */
  .summary-stats {
    @apply bg-card/50 rounded-lg p-3 flex flex-col gap-2;
  }
  
  .stat-row {
    @apply flex items-center gap-2 text-sm;
  }
  
  .stat-label {
    @apply text-gray-500 text-xs uppercase tracking-wider w-12 flex-shrink-0;
  }
  
  .stat-value {
    @apply font-semibold text-white;
  }
  
  .stat-bar {
    @apply flex-1 h-1.5 bg-gray-700 rounded-full overflow-hidden ml-2;
  }
  
  .stat-bar-fill {
    @apply h-full bg-blue-500 rounded-full transition-all;
  }
  
  .stat-bar-fill.complete {
    @apply bg-green-500;
  }
  
  .stat-age {
    @apply text-xs text-gray-500 ml-1;
  }
  
  .stat-update-btn {
    @apply ml-2 text-[10px] bg-amber-500 text-black px-2 py-0.5 rounded-full font-semibold hover:bg-amber-400 transition-colors;
  }
  
  .stat-row.stale .stat-label {
    @apply text-amber-400/70;
  }
  
  .summary-value {
    @apply text-4xl font-extrabold tracking-tight leading-tight;
  }
  
  .summary-unit {
    @apply text-lg font-normal text-gray-400 ml-1;
  }
  
  .summary-subtext {
    @apply text-sm text-gray-400;
  }
  
  .summary-row.feed .summary-value {
    @apply text-normal;
  }
  
  .summary-row.urgent .summary-time {
    @apply animate-pulse;
  }
  
  .summary-divider {
    @apply w-full h-px bg-border;
  }
  
  /* Medications row */
  .summary-meds-right {
    @apply flex flex-col items-end gap-0.5;
  }
  
  .summary-med-name {
    @apply text-xl font-bold text-white leading-tight;
  }
  
  .summary-row.urgent .summary-med-name {
    @apply text-urgent;
  }
  
  .summary-row.soon .summary-med-name {
    @apply text-yellow-400;
  }
  
  .summary-med-done {
    @apply text-xl text-green-500 font-medium;
  }
  
  .summary-med-empty {
    @apply text-sm text-gray-500 italic;
  }
  
  /* Tablet: slightly larger */
  @media (min-width: 640px) {
    .summary-time {
      @apply text-5xl;
    }
    
    .summary-value {
      @apply text-5xl;
    }
    
    .summary-unit {
      @apply text-2xl;
    }
    
    .summary-med-name {
      @apply text-2xl;
    }
    
    .summary-label {
      @apply text-xs;
    }
  }
  
  /* Mobile phone: reduce padding to maximize space */
  @media (max-width: 639px) {
    .child-panel {
      padding: 0.5rem !important;
      padding-bottom: calc(0.5rem + env(safe-area-inset-bottom, 0px)) !important;
    }
    
    .child-panel .mb-2 {
      margin-bottom: 0.25rem;
    }
    
    .child-panel .mb-3 {
      margin-bottom: 0.375rem;
    }
    
    .planner-tab {
      @apply py-1.5 text-[10px];
    }
    
    .summary-content {
      @apply gap-4 px-3;
    }
    
    .summary-time {
      @apply text-3xl;
    }
    
    .summary-value {
      @apply text-3xl;
    }
    
    .summary-unit {
      @apply text-base;
    }
    
    .summary-med-name {
      @apply text-lg;
    }
  }
  
  /* Sync status indicator */
  .sync-status {
    @apply text-xs px-2 py-0.5 rounded-full flex items-center gap-1 transition-all duration-300;
  }
  
  .sync-status .sync-icon {
    @apply text-[10px] transition-colors duration-300;
  }
  
  .sync-status.synced .sync-icon {
    @apply text-green-500;
  }
  
  .sync-status.syncing .sync-icon {
    @apply text-yellow-500 animate-pulse;
  }
  
  .sync-status.offline .sync-icon {
    @apply text-gray-500;
  }
  
  .sync-status.error .sync-icon {
    @apply text-red-500;
  }
  
  /* Realtime connected indicator - pulsing green dot */
  .sync-status.realtime .sync-icon {
    @apply text-green-400;
    animation: pulse-realtime 2s ease-in-out infinite;
  }
  
  @keyframes pulse-realtime {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(0.9); }
  }
  
  /* Medication grid - fixed size buttons, responsive columns */
  .meds-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
  }
  
  /* When only add-new button exists, make it fill the container */
  .meds-grid:has(.add-new:only-child) {
    display: flex;
  }
  
  .meds-grid .add-new:only-child {
    flex: 1;
    width: 100%;
    gap: 0.5rem;
  }
  
  /* Mobile phone adjustments */
  @media (max-width: 639px) {
    .meds-wrapper .meds-grid {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .meds-wrapper {
      height: 180px !important;
    }
    
    .controls-section .bg-panel {
      padding: 0.5rem;
    }
    
    /* Smaller feed/diaper row on mobile */
    .controls-section .flex.gap-2.h-20 {
      height: 4.5rem;
    }
    
    .feed-adjust-btn {
      width: 2.5rem !important;
    }
    
    .controls-section button[data-action="log-diaper"] {
      width: 4rem !important;
    }
  }
  
  /* On larger screens, show more columns */
  @media (min-width: 1200px) {
    .meds-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }
  
  @media (min-width: 1600px) {
    .meds-grid {
      grid-template-columns: repeat(5, 1fr);
    }
  }
  
  .planner-viewport {
    scrollbar-width: thin;
    scrollbar-color: #2a3a5a transparent;
    touch-action: pan-y;
    -webkit-overflow-scrolling: touch;
  }
  
  .planner-content {
    will-change: transform;
    transform-origin: top left;
  }
  
  /* Enable GPU acceleration for text elements during zoom */
  .planner-content .planner-text,
  .planner-content .planner-event {
    transform-origin: left center;
    will-change: transform;
  }
  
  .planner-viewport::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  
  .planner-viewport::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .planner-viewport::-webkit-scrollbar-thumb {
    background: #2a3a5a;
    border-radius: 3px;
  }
  
  /* Feed control swipe styles */
  .feed-control {
    touch-action: pan-x;
    user-select: none;
    -webkit-user-select: none;
  }
  
  .feed-control:active {
    background: rgba(255, 255, 255, 0.05);
  }
  
  .feed-swipe-area {
    position: relative;
    overflow: hidden;
  }
  
  .feed-swipe-area::before {
    content: '‚àí';
    position: absolute;
    left: -20px;
    opacity: 0;
    color: #ef4444;
    font-weight: bold;
    transition: opacity 0.15s, left 0.15s;
  }
  
  .feed-swipe-area::after {
    content: '+';
    position: absolute;
    right: -20px;
    opacity: 0;
    color: #22c55e;
    font-weight: bold;
    transition: opacity 0.15s, right 0.15s;
  }
  
  .feed-control.swiping-left .feed-swipe-area::before {
    opacity: 1;
    left: 4px;
  }
  
  .feed-control.swiping-right .feed-swipe-area::after {
    opacity: 1;
    right: 4px;
  }
  
  /* Feed arrows for visual affordance */
  .feed-arrow {
    font-size: 0.65rem;
    color: rgba(148, 163, 184, 0.5);
    transition: all 0.15s ease;
  }
  
  .feed-arrow-left {
    margin-right: 0.5rem;
  }
  
  .feed-arrow-right {
    margin-left: 0.5rem;
  }
  
  .feed-control:hover .feed-arrow {
    color: rgba(148, 163, 184, 0.8);
  }
  
  .feed-control.swiping-left .feed-arrow-left {
    color: #ef4444;
    transform: translateX(-2px);
  }
  
  .feed-control.swiping-right .feed-arrow-right {
    color: #22c55e;
    transform: translateX(2px);
  }
</style>
