---
interface Props {
  side: 'left' | 'right';
  childIndex: number;
  defaultName: string;
}

const { side, childIndex, defaultName } = Astro.props;
const isLeft = side === 'left';
---

<div 
  class:list={[
    'child-panel h-full flex flex-col p-4 overflow-hidden relative',
    { 'border-r-2 border-border': isLeft }
  ]}
  data-child={childIndex}
>
  <!-- Floating urgent tooltip -->
  <div class="urgent-tooltip" id={`urgent-tooltip-${childIndex}`}>
    <span class="tooltip-icon">‚è∞</span>
    <span class="tooltip-text" id={`tooltip-text-${childIndex}`}></span>
    <div class="tooltip-buttons">
      <button class="tooltip-btn ignore-btn" data-action="dismiss-tooltip" data-child={childIndex}>Ignore</button>
      <button class="tooltip-btn add-btn" data-action="add-overdue-med" data-child={childIndex}>Add</button>
    </div>
  </div>

  <!-- Header -->
  <div class="flex justify-between items-center mb-2">
    <h1 
      class:list={[
        'text-2xl font-bold cursor-pointer',
        isLeft ? 'text-accent-left' : 'text-accent-right'
      ]}
      data-child-name={childIndex}
    >
      {defaultName}
    </h1>
    <div class="flex items-center gap-2">
      {isLeft && (
        <div class="sync-status" id="sync-status" title="Sync status">
          <span class="sync-icon">‚óè</span>
        </div>
      )}
      <span class="date-display text-sm text-gray-400"></span>
    </div>
  </div>
  
  <!-- Daily Planner (Top Section - ~60% height) -->
  <div class="planner-container flex-1 bg-panel rounded-xl mb-3 overflow-hidden min-h-0 relative">
    <div 
      class="planner-viewport h-full overflow-auto"
      id={`planner-${childIndex}`}
      data-child={childIndex}
    >
      <div class="planner-content" id={`planner-content-${childIndex}`}>
        <!-- Timeline will be rendered here -->
      </div>
    </div>
    <!-- Done button for event edit mode -->
    <button 
      class="event-edit-done-btn"
      id={`event-edit-done-${childIndex}`}
      onclick={`exitEventEditMode(${childIndex})`}
    >
      Done
    </button>
  </div>
  
  <!-- Bottom Controls Section -->
  <div class="controls-section flex flex-col gap-2 flex-shrink-0">
    <!-- Meds Row - Fixed height with scrollable grid -->
    <div class="bg-panel rounded-xl p-3 h-[220px] flex flex-col meds-wrapper">
      <div class="flex justify-between items-center mb-2 flex-shrink-0">
        <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Medications</span>
        <button 
          class="bg-card border border-dashed border-border text-gray-400 px-2 py-1 rounded text-xs font-semibold cursor-pointer transition-all hover:border-normal hover:text-normal"
          data-action="open-med-settings" 
          data-child={childIndex}
        >
          +
        </button>
      </div>
      <div id={`meds-grid-${childIndex}`} class="meds-grid gap-2 overflow-y-auto flex-1"></div>
    </div>
    
    <!-- Feed & Diapers Row -->
    <div class="bg-panel rounded-xl p-3 flex-shrink-0">
      <div class="flex gap-2">
        <!-- Feed control with swipe - flexible width -->
        <div 
          class="feed-control flex-1 flex items-center bg-card border border-border rounded-lg overflow-hidden cursor-pointer select-none"
          id={`feed-control-${childIndex}`}
        >
          <div class="feed-icon w-12 h-14 flex items-center justify-center text-xl border-r border-border/50">
            üçº
          </div>
          <div 
            class="feed-swipe-area flex-1 h-14 px-4 flex items-center justify-center gap-2"
            id={`feed-swipe-${childIndex}`}
          >
            <span class="text-xl font-bold" id={`feed-amount-${childIndex}`}>120</span>
            <span class="text-sm text-gray-400">mL</span>
          </div>
        </div>
        
        <!-- Diaper buttons - fixed width -->
        <button 
          class="w-16 h-14 border border-border rounded-lg text-base font-semibold cursor-pointer flex items-center justify-center gap-1 bg-card text-white active:scale-95 transition-all"
          data-action="log-diaper" 
          data-child={childIndex} 
          data-type="pee"
        >
          üíß <span id={`pee-count-${childIndex}`}>0</span>
        </button>
        <button 
          class="w-16 h-14 border border-border rounded-lg text-base font-semibold cursor-pointer flex items-center justify-center gap-1 bg-card text-white active:scale-95 transition-all"
          data-action="log-diaper" 
          data-child={childIndex} 
          data-type="poop"
        >
          üí© <span id={`poop-count-${childIndex}`}>0</span>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .child-panel.has-urgent {
    animation: glow 2s infinite;
  }
  
  @keyframes glow {
    0%, 100% { background: transparent; }
    50% { background: rgba(239, 68, 68, 0.05); }
  }
  
  /* Mobile phone: reduce padding to maximize space */
  @media (max-width: 639px) {
    .child-panel {
      padding: 0.5rem !important;
      padding-bottom: calc(0.5rem + env(safe-area-inset-bottom, 0px)) !important;
    }
    
    .child-panel .mb-2 {
      margin-bottom: 0.25rem;
    }
    
    .child-panel .mb-3 {
      margin-bottom: 0.375rem;
    }
  }
  
  /* Sync status indicator */
  .sync-status {
    @apply text-xs px-2 py-0.5 rounded-full flex items-center gap-1 transition-all duration-300;
  }
  
  .sync-status .sync-icon {
    @apply text-[10px] transition-colors duration-300;
  }
  
  .sync-status.synced .sync-icon {
    @apply text-green-500;
  }
  
  .sync-status.syncing .sync-icon {
    @apply text-yellow-500 animate-pulse;
  }
  
  .sync-status.offline .sync-icon {
    @apply text-gray-500;
  }
  
  .sync-status.error .sync-icon {
    @apply text-red-500;
  }
  
  /* Medication wrapper - allows overflow for delete buttons */
  .meds-wrapper {
    overflow: hidden;
  }
  
  .meds-wrapper:has(.meds-grid.edit-mode) {
    overflow: visible;
  }
  
  /* Medication grid - fixed size buttons, responsive columns */
  .meds-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .meds-grid.edit-mode {
    overflow: visible;
  }
  
  /* Mobile phone adjustments - shrink meds and planner to fit controls */
  @media (max-width: 639px) {
    .meds-wrapper {
      height: 140px !important;
    }
    
    .meds-wrapper .meds-grid {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .planner-container {
      flex: 1 1 0;
      min-height: 120px;
      max-height: 35vh;
    }
    
    .controls-section {
      gap: 0.375rem;
    }
    
    .controls-section .bg-panel {
      padding: 0.5rem;
    }
    
    .feed-icon {
      width: 2.5rem !important;
      height: 3rem !important;
    }
    
    .feed-swipe-area {
      height: 3rem !important;
    }
    
    .controls-section button[data-action="log-diaper"] {
      width: 3.5rem !important;
      height: 3rem !important;
    }
  }
  
  /* On larger screens, show more columns */
  @media (min-width: 1200px) {
    .meds-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }
  
  @media (min-width: 1600px) {
    .meds-grid {
      grid-template-columns: repeat(5, 1fr);
    }
  }
  
  .planner-viewport {
    scrollbar-width: thin;
    scrollbar-color: #2a3a5a transparent;
    touch-action: pan-y;
    -webkit-overflow-scrolling: touch;
  }
  
  .planner-content {
    will-change: transform;
    transform-origin: top left;
  }
  
  /* Enable GPU acceleration for text elements during zoom */
  .planner-content .planner-text,
  .planner-content .planner-event {
    transform-origin: left center;
    will-change: transform;
  }
  
  .planner-viewport::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  
  .planner-viewport::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .planner-viewport::-webkit-scrollbar-thumb {
    background: #2a3a5a;
    border-radius: 3px;
  }
  
  /* Feed control swipe styles */
  .feed-control {
    touch-action: pan-x;
    user-select: none;
    -webkit-user-select: none;
  }
  
  .feed-control:active {
    background: rgba(255, 255, 255, 0.05);
  }
  
  .feed-swipe-area {
    position: relative;
    overflow: hidden;
  }
  
  .feed-swipe-area::before {
    content: '‚àí';
    position: absolute;
    left: -20px;
    opacity: 0;
    color: #ef4444;
    font-weight: bold;
    transition: opacity 0.15s, left 0.15s;
  }
  
  .feed-swipe-area::after {
    content: '+';
    position: absolute;
    right: -20px;
    opacity: 0;
    color: #22c55e;
    font-weight: bold;
    transition: opacity 0.15s, right 0.15s;
  }
  
  .feed-control.swiping-left .feed-swipe-area::before {
    opacity: 1;
    left: 4px;
  }
  
  .feed-control.swiping-right .feed-swipe-area::after {
    opacity: 1;
    right: 4px;
  }
</style>
